<!DOCTYPE html>
<html lang="en">
<script>
  // Apply dark mode class *before* page paints
  (function () {
    try {
      const isDark = localStorage.getItem('darkMode') === 'true';
      if (isDark) document.documentElement.classList.add('dark-mode');
    } catch (e) { }
  })();
</script>

<head>
  <!-- Chat application metadata and dependencies -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat - SyväAI</title>
  <link rel="icon" href="/logos/logo/SyvaAI.png" type="image/png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <!-- Firebase v8 SDK bundles for chat authentication -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

  <!-- Markdown and DOMPurify -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Google+Sans+Code:ital,wght@0,300..800;1,300..800&family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet">
  <!-- Firestore enables chat history storage -->
  <script type="module" src="index.js"></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0d0d0d;
      color: white;
    }
  </style>
</head>

<body class="flex items-center justify-center min-h-screen">
  <!-- Geolocation guard to enforce blocked regions -->
  <script>
    // Blocked countries
    const BLOCKED_COUNTRIES = ['CN', 'IR', 'KP', 'SY', 'CU', 'RU', 'BY', 'MM', 'VE', 'SD', 'AF', 'SL', 'UA', 'TR'];

    // Check user's country on page load
    async function checkGeoblock() {
      try {
        // Use free IP geolocation API
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();

        const countryCode = data.country_code;

        console.log('User country:', countryCode);

        if (BLOCKED_COUNTRIES.includes(countryCode)) {
          // Block access
          document.body.innerHTML = `
        <div style="
          display: flex;
          justify-content: center;
          align-items: center;
          height: 100vh;
          background: #1a1a1a;
          color: white;
          font-family: Arial, sans-serif;
          text-align: center;
          padding: 20px;
        ">
          <div>
            <h1>Access Denied</h1>
            <p>Access to this service is not available in your region.</p>
            <p style="color: #888; font-size: 14px;">Country: ${countryCode}</p>
          </div>
        </div>
      `;

          // Prevent any further script execution
          throw new Error('Geoblocked');
        }
      } catch (error) {
        if (error.message === 'Geoblocked') {
          throw error;
        }
        // If geolocation fails, allow access (fail-open)
        console.log('Geolocation check failed, allowing access');
      }
    }

    // Run check immediately
    checkGeoblock();
  </script>
  <!-- Firebase initialization and authentication guard -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD_qlUue2zbN98YbZEdiTAUoGfD9AQ1250",
      authDomain: "syvaai-website.firebaseapp.com",
      databaseURL: "https://syvaai-website-default-rtdb.firebaseio.com",
      projectId: "syvaai-website",
      storageBucket: "syvaai-website.appspot.com",
      messagingSenderId: "617237097658",
      appId: "1:617237097658:web:f037266cbbf5d82e80e683",
      measurementId: "G-CPMSS94CFR",
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    } else {
      firebase.app(); // If already initialized
    }
    document.addEventListener("DOMContentLoaded", function () {
      // Firebase authentication check when the page loads
      firebase.auth().onAuthStateChanged(user => {
        if (!user) {
          // If the user is not signed in, redirect them to the sign-in page
          window.location.href = "5667862vc72647237n67an769ndn793n6n9a76wr9wra.html"; // Redirect to your sign-in page
        }
      });
    });

  </script>







  <style>
    /* Main content area - shift right on desktop to make room for sidebar */
    .w-screen {
      margin-left: 0;
      transition: margin-left 0.4s;
    }

    @media (min-width: 769px) {
      .w-screen {
        margin-left: 250px;
        /* Make room for sidebar on desktop */
      }
    }

    /* General styles */
    .chat-container {
      width: 100%;
      height: 80vh;
      border-radius: 15px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .input-area {
      max-width: none;
      width: 100%;
      display: flex;
      padding: 18px 20px;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .chat-shell {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 100%;
      height: 100%;
    }

    .chat-toolbar {
      display: flex;
      justify-content: flex-end;
      flex-wrap: wrap;
      gap: 10px;
    }

    .sidebar-toolbar {
      display: flex;
      justify-content: flex-start;
      flex-wrap: wrap;
      gap: 15px;
      padding: 10px 12px;
    }

    .input-area input {
      background-color: #161616;
      color: white;
      border-radius: 30px;
      padding: 12px 20px;
      border: 1px solid #444;
      width: 90%;
      font-size: 14px;
      outline: none;
    }

    .show {
      display: block;
    }

    .input-area button {
      background: linear-gradient(90deg, #3b82f6, #9333ea);
      padding: 12px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .input-area button svg {
      fill: white;
      width: 20px;
      height: 20px;
    }

    .input-area input:focus {
      border-color: #4c4cff;
    }

    #chatbutton {
      background-color: #000;
      color: #fff;
      padding: 15px 32px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
    }

    #chatbutton:hover {
      background-color: #161616;
    }

#chat {
  text-align: center; /* Center for greeting */
  width: 100%;
  padding: 20px;
  max-height: 65vh;
  flex: 1;
  border-radius: 12px;
  overflow-y: auto;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center; /* Center children horizontally */
  justify-content: center; /* Center children vertically */
}

/* When messages exist, switch back to normal layout */
#chat:has(.message:not(.greeting-message)) {
  justify-content: flex-start;
  align-items: stretch;
}


    #input {
      outline: none;
    }

.message {
  max-width: 80%;
  padding: 12px 16px;
  border-radius: 18px;
  margin: 8px 0;
  display: block;
  clear: both;
  float: none !important; /* Override the float */
  text-align: left;
}



    .group {
      position: relative;
    }

    .input {
      font-size: 16px;
      padding: 10px 10px 10px 5px;
      display: block;
      border: none;
      border-bottom: 1px solid #515151;
      background: transparent;
    }

    .input:focus {
      outline: none;
    }

    label {
      color: #999;
      font-size: 18px;
      font-weight: normal;
      position: absolute;
      pointer-events: none;
      left: 5px;
      top: 10px;
      transition: 0.2s ease all;
      -moz-transition: 0.2s ease all;
      -webkit-transition: 0.2s ease all;
    }

    .input:focus~label,
    .input:valid~label {
      top: -20px;
      font-size: 14px;
      color: #5264AE;
    }

    .bar {
      position: relative;
      display: block;
      /* width: 200px; */
    }

    .bar:before,
    .bar:after {
      content: '';
      height: 2px;
      width: 0;
      bottom: 1px;
      position: absolute;
      background: #5264AE;
      transition: 0.2s ease all;
      -moz-transition: 0.2s ease all;
      -webkit-transition: 0.2s ease all;
    }

    .bar:before {
      left: 50%;
    }

    .bar:after {
      right: 50%;
    }

    .input:focus~.bar:before,
    .input:focus~.bar:after {
      width: 50%;
    }

    .highlight {
      position: absolute;
      height: 60%;
      width: 100px;
      top: 25%;
      left: 0;
      pointer-events: none;
      opacity: 0.5;
    }

    .input:focus~.highlight {
      animation: inputHighlighter 0.3s ease;
    }

    @keyframes inputHighlighter {
      from {
        background: #5264AE;
      }

      to {
        width: 0;
        background: transparent;
      }
    }



    .message-user {
    /* background-color: #2d2d2e; */
      /* background-color: #3b82f6; */
  color: white;
      float: right;
      text-align: left;
      border-bottom-right-radius: 0;
      font-size: 15px;
      align-self: flex-end; 
    }

    .message-ai {
      /* background-color: #444;
  color: white; */
      float: left;
      text-align: left;
      border-bottom-left-radius: 0;
      font-size: 15px;
    }


    /* Container */
    .login-container {
      background: #ffffff;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      width: 500px;
      /* Instead of 100% */
      max-width: 90%;
      height: auto;
      /* Instead of 100% */
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }


    .login-containertwo {
      padding: 20px;
      text-align: center;
      width: 20%;
      height: 100%;
    }

    .seperator {
      border-radius: 10px;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 10px;
    }

    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #ffffff;
      overflow: auto;
      box-shadow: 0px 4px 12px 0px rgba(0, 0, 0, 0.15);
      z-index: 2;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .dropdown-content a {
      color: #333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      font-size: 15px;
      transition: background-color 0.2s ease;
    }

    .dropdown-content a:hover {
      background-color: #f5f5f5;
    }


    .popup {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: rgba(0, 0, 0);
      color: white;
      padding: 10px;
      border-radius: 5px;
      display: none;
      /* Start hidden */
      opacity: 0;
      transition: opacity 0.5s;
      max-width: 270px;
      z-index: 1000;
    }

    .close-btn {
      width: 100%;
      padding: 12px;
      background: #007bff;
      border: none;
      color: white;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .close-btn:hover {
      background: #0056b3;
    }

    .input-group {
      position: relative;
      margin-bottom: 15px;
    }

    /* Heading */
    h2 {
      margin-bottom: 20px;
      font-size: 24px;
      color: #333;
    }

    /* Input fields */
    .input-group {
      position: relative;
      margin-bottom: 15px;
    }

    .input-group input {
      width: 90%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.3s;
    }

    .input-group input:focus {
      border-color: #007bff;
    }

    /* Button */
    .userbutton {
      width: 100%;
      padding: 10px;
      background: #0d0d0d;
      border: 10px white;
      color: rgb(31, 31, 31);
      font-size: 16px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.3s;

    }



    .darkmode {
      padding: 10px;
      background: #e0e0e0;
      border: none;
      color: white;
      font-size: 16px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.3s;

    }

    .menubut {
      padding: 10px;
      background: #0d0d0d;
      border: 10px #FFFF;
      color: rgb(31, 31, 31);
      font-size: 16px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.3s;

    }

    .spinner {
      --size: 30px;
      --color: white;
      width: 100px;
      height: 100px;
      position: relative;
    }

    .spinner::after,
    .spinner::before {
      box-sizing: border-box;
      position: absolute;
      content: "";
      width: var(--size);
      height: var(--size);
      top: 50%;
      animation: up 2.4s cubic-bezier(0, 0, 0.24, 1.21) infinite;
      left: 50%;
      background: var(--color);
      box-shadow: 0 0 calc(var(--size) / 3) rgba(0, 0, 0, 0.25);
    }

    .spinner::after {
      background: var(--color);
      top: calc(50% - var(--size));
      left: calc(50% - var(--size));
      animation: down 2.4s cubic-bezier(0, 0, 0.24, 1.21) infinite;
    }

    @keyframes down {

      0%,
      100% {
        transform: none;
      }

      25% {
        transform: translateX(100%);
      }

      50% {
        transform: translateX(100%) translateY(100%);
      }

      75% {
        transform: translateY(100%);
      }
    }

    @keyframes up {

      0%,
      100% {
        transform: none;
      }

      25% {
        transform: translateX(-100%);
      }

      50% {
        transform: translateX(-100%) translateY(-100%);
      }

      75% {
        transform: translateY(-100%);
      }
    }

  
    .userbutton:hover {
      background: #d6d6d6;
    }

    .darkmode:hover {
      background: #d6d6d6;
    }

    .menubut:hover {
      background: #d6d6d6;
    }

    /* Sign-up link */
    .signup-link {
      margin-top: 10px;
      font-size: 14px;
    }

    .signup-link a {
      color: #007bff;
      text-decoration: none;
    }

    .signup-link a:hover {
      text-decoration: underline;
    }

    /* Overlay */
    .iframe-popup {
      display: none;
      /* hidden by default */
      position: fixed;
      inset: 0;
      /* full screen */
      background: transparent;
      /* transparency */
      justify-content: center;
      align-items: center;
      z-index: 9999;
      /* above everything */
    }

    /* Content box */
    .iframe-content {
      position: relative;
      background: white;
      min-width: 30%;
      height: 70%;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Close button */
    .iframe-content .close-btn {
      position: absolute;
      top: 8px;
      right: 12px;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }

    /* Iframe itself */
    .iframe-content iframe {
      width: 100%;
      height: 100%;
      border: none;
    }


    /* From Uiverse.io by LilaRest */
    .card {
      --bg: #e8e8e8;
      --contrast: #e2e0e0;
      --grey: #93a1a1;
      position: relative;
      padding: 18px;
      background-color: var(--bg);
      border-radius: 35px;
      box-shadow: rgba(50, 50, 93, 0.25) 0px 50px 100px -20px, rgba(0, 0, 0, 0.3) 0px 30px 60px -30px, rgba(10, 37, 64, 0.35) 0px -2px 6px 0px inset;
      max-width: min(1180px, 94vw);
      margin: 40px auto;
    }

    .card-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: repeating-conic-gradient(var(--bg) 0.0000001%, var(--grey) 0.000104%) 60% 60%/600% 600%;
      filter: opacity(10%) contrast(105%);
    }

    .card-inner {
      display: flex;
      flex-direction: column;
      justify-content: stretch;
      align-items: stretch;
      overflow: hidden;
      width: 100%;
      min-height: 72vh;
      padding: 24px 28px;
      gap: 18px;
      background-color: var(--contrast);
      border-radius: 30px;
    }

    /* From Uiverse.io by JaydipPrajapati1910 */
    .card.dark {
      --bg: #555;
      --contrast: #2c2c2c;
      --grey: #373838;
      position: relative;
      padding: 18px;
      background-color: var(--bg);
      border-radius: 35px;
      border-width: 0px;
      box-shadow: rgba(50, 50, 93, 0.25) 0px 50px 100px -20px, rgba(0, 0, 0, 0.3) 0px 30px 60px -30px, rgba(10, 37, 64, 0.35) 0px -2px 6px 0px inset;
      max-width: min(1180px, 94vw);
      margin: 40px auto;
    }

    .card-overlay.dark {
      position: absolute;
      inset: 0;
      pointer-events: none;
      background: repeating-conic-gradient(var(--bg) 0.0000001%, var(--grey) 0.000104%) 60% 60%/600% 600%;
      filter: opacity(10%) contrast(105%);
    }

    .card-inner.dark {
      display: flex;
      flex-direction: column;
      justify-content: stretch;
      align-items: stretch;
      overflow: hidden;
      width: 100%;
      min-height: 72vh;
      padding: 24px 28px;
      gap: 18px;
      background-color: var(--contrast);
      border-radius: 30px;
    }

    .error-alert {
      position: relative;
      width: 100%;
      max-width: 16rem;
      /* 256px / 16 = 16rem */
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      padding: 0.75rem 1rem;
      /* py-3 px-4 */
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.5s ease;
      border: 1px solid #f85149;
      color: #b22b2b;
      background: linear-gradient(#f851491a, #f851491a);
    }

    .error-alert svg {
      color: #b22b2b;
    }

    .container-ia-chat {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      width: 100%;
    }

    .container-upload-files {
      position: absolute;
      left: 0;
      display: flex;
      color: #aaaaaa;
      transition: all 0.5s;

      & .upload-file {
        margin: 5px;
        padding: 2px;
        cursor: pointer;
        transition: all 0.5s;

        &:hover {
          color: #4c4c4c;
          scale: 1.1;
        }
      }
    }

    .input-text {
      width: 98%;
      margin-left: 72px;
      padding: 0.75rem 1rem;
      padding-right: 46px;
      border-radius: 50px;
      border: none;
      outline: none;
      background-color: #e9e9e9;
      color: #4c4c4c;
      font-size: 14px;
      line-height: 18px;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      font-weight: 500;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.05);
      z-index: 999;

      body.dark-mode .input-text {
        background-color: rgba(12, 12, 12, 0.75);
        color: #f5f5f5;
      }

      &::placeholder {
        color: #959595;
      }

      &:focus-within,
      &:valid {
        width: 99%;
        margin-left: 42px;

        &~.container-upload-files {
          opacity: 0;
          visibility: hidden;
          pointer-events: none;
          filter: blur(5px);
        }

        &~.label-files {
          transform: translateX(0) translateY(-50%) scale(1);
          opacity: 1;
          visibility: visible;
          pointer-events: all;
        }
      }

      &::selection {
        background-color: #4c4c4c;
        color: #e9e9e9;
      }

      &:valid~.label-text {
        transform: translateX(0) translateY(-50%) scale(1);
        opacity: 1;
        visibility: visible;
        pointer-events: all;
      }

      &:valid~.label-voice {
        transform: translateX(0) translateY(-50%) scale(0.25);
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
      }
    }

    .input-voice {
      display: none;

      &:checked~.container-upload-files {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        filter: blur(5px);
      }

      &:checked~.input-text {
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        filter: blur(5px);
      }
    }

    .label-files {
      position: absolute;
      top: 50%;
      left: 0;
      transform: translateX(-20px) translateY(-50%) scale(1);
      display: flex;
      padding: 0.5rem;
      color: #959595;
      background-color: #e9e9e9;
      border-radius: 50px;
      cursor: pointer;
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.05);

      &:focus-visible,
      &:hover {
        color: #4c4c4c;
      }
    }

    .label-voice,
    .label-text {
      position: absolute;
      top: 50%;
      right: 0.25rem;
      transform: translateX(0) translateY(-50%) scale(1);
      width: 36px;
      height: 36px;
      display: flex;
      padding: 6px;
      border: none;
      outline: none;
      cursor: pointer;
      transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.05);
      z-index: 999;
    }

    .input-voice:checked~.label-voice {
      background-color: #e9e9e9;
      right: 0;
      width: 300px;
      height: 300px;
      border-radius: 3rem;
      box-shadow:
        0 10px 40px rgba(0, 0, 60, 0.25),
        inset 0 0 10px rgba(255, 255, 255, 0.5);

      & .icon-voice {
        opacity: 0;
      }

      & .text-voice p {
        opacity: 1;
      }
    }

    .label-voice {
      color: #959595;
      overflow: hidden;

      &:hover,
      &:focus-visible {
        color: #4c4c4c;
      }

      &:active svg {
        scale: 1.1;
      }

      & .icon-voice {
        position: absolute;
        transition: all 0.3s;
      }

      & .text-voice {
        position: absolute;
        inset: 1.25rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;

        & p {
          opacity: 0;
          transition: all 0.3s;
          text-wrap: nowrap;

          &:first-child {
            font-size: 20px;
            font-weight: 500;
            color: transparent;
            background-image: linear-gradient(-40deg,
                #959595 0% 35%,
                #e770cd 40%,
                #ffcef4 50%,
                #e770cd 60%,
                #959595 65% 100%);
            background-clip: text;
            background-size: 900px;
            animation: text-light 6s ease infinite;
          }

          &:last-child {
            font-size: 12px;
            color: #2b2b2b;
            mix-blend-mode: difference;
          }
        }
      }
    }

    @keyframes text-light {
      0% {
        background-position: 0px;
      }

      100% {
        background-position: 900px;
      }
    }

    .label-text {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translateY(-50%) scale(0.25);
      color: #e9e9e9;
      background: linear-gradient(to top right, #9147ff, #ff4141);
      box-shadow: inset 0 0 4px rgba(255, 255, 255, 0.5);
      border-radius: 50px;

      &:hover,
      &:focus-visible {
        transform-origin: top center;
        box-shadow: inset 0 0 6px rgba(255, 255, 255, 1);
      }

      &:active {
        scale: 0.9;
      }
    }

    .ai {
      --z: 0;
      --s: 300px;
      --p: calc(var(--s) / 4);
      width: var(--s);
      aspect-ratio: 1;
      padding: var(--p);
      display: grid;
      place-items: center;
      position: relative;
      animation: circle1 5s ease-in-out infinite;

      &::before,
      &::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 50%;
        height: 50%;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 30px rgba(234, 170, 255, 1);
        filter: blur(5px);
        transform: translate(-50%, -50%);
        animation: wave 1.5s linear infinite;
      }

      &::after {
        animation-delay: 0.4s;
      }
    }

    @keyframes wave {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0;
        box-shadow: 0 0 50px rgba(234, 170, 255, 0.9);
      }

      35% {
        transform: translate(-50%, -50%) scale(1.3);
        opacity: 1;
      }

      70%,
      100% {
        transform: translate(-50%, -50%) scale(1.6);
        opacity: 0;
        box-shadow: 0 0 50px rgba(234, 170, 255, 0.3);
      }
    }

    @keyframes ai1 {
      0% {
        transform: rotate(0deg) translate(50%) scale(0.9);
        opacity: 0;
      }

      25% {
        transform: rotate(90deg) translate(50%) scale(1.8);
        opacity: 1;
      }

      50% {
        transform: rotate(180deg) translate(50%) scale(0.7);
        opacity: 0.4;
      }

      75% {
        transform: rotate(270deg) translate(50%) scale(1.2);
        opacity: 1;
      }

      100% {
        transform: rotate(360deg) translate(50%) scale(0.9);
        opacity: 0;
      }
    }

    @keyframes ai2 {
      0% {
        transform: rotate(90deg) translate(50%) scale(0.5);
      }

      25% {
        transform: rotate(180deg) translate(50%) scale(1.7);
        opacity: 0;
      }

      50% {
        transform: rotate(270deg) translate(50%) scale(1);
        opacity: 0;
      }

      75% {
        transform: rotate(360deg) translate(50%) scale(0.8);
        opacity: 0;
      }

      100% {
        transform: rotate(450deg) translate(50%) scale(0.5);
        opacity: 1;
      }
    }

    @keyframes ai3 {
      0% {
        transform: rotate(180deg) translate(50%) scale(0.8);
        opacity: 0.8;
      }

      25% {
        transform: rotate(270deg) translate(50%) scale(1.5);
      }

      50% {
        transform: rotate(360deg) translate(50%) scale(0.6);
        opacity: 0.4;
      }

      75% {
        transform: rotate(450deg) translate(50%) scale(1.3);
        opacity: 0.7;
      }

      100% {
        transform: rotate(540deg) translate(50%) scale(0.8);
        opacity: 0.8;
      }
    }

    @keyframes ai4 {
      0% {
        transform: rotate(270deg) translate(50%) scale(1);
        opacity: 1;
      }

      25% {
        transform: rotate(360deg) translate(50%) scale(0.7);
      }

      50% {
        transform: rotate(450deg) translate(50%) scale(1.6);
        opacity: 0.5;
      }

      75% {
        transform: rotate(540deg) translate(50%) scale(0.9);
        opacity: 0.8;
      }

      100% {
        transform: rotate(630deg) translate(50%) scale(1);
        opacity: 1;
      }
    }

    .c {
      position: absolute;
      width: 300px;
      aspect-ratio: 1;
      border-radius: 50%;
    }

    .c1 {
      background: radial-gradient(50% 50% at center, #c979ee, #74bcd6);
      width: 200px;
      animation: ai1 5.5s linear infinite;
    }

    .c2 {
      background: radial-gradient(50% 50% at center, #ef788c, #e7e7fb);
      width: 100px;
      animation: ai2 6s linear infinite;
    }

    .c3 {
      background: radial-gradient(50% 50% at center, #eb7fc6, transparent);
      width: 150px;
      opacity: 0.6;
      animation: ai3 4.8s linear infinite;
    }

    .c4 {
      background: #6d67c8;
      animation: ai4 5.2s linear infinite;
    }

    .container {
      overflow: hidden;
      background: #b6a9f8;
      width: 100%;
      border-radius: 50%;
      aspect-ratio: 1;
      position: relative;
      display: grid;
      place-items: center;
    }


    .iframe-center-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 9999;
    }

    .iframe-center-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .iframe-center-box {
      width: 80%;
      max-width: 900px;
      height: 70%;
      background: rgba(30, 30, 30, 0.9);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      transform: scale(0.95);
      transition: transform 0.25s ease;
    }

    .iframe-center-overlay.visible .iframe-center-box {
      transform: scale(1);
    }

    .iframe-center-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.05);
      padding: 0.4rem 0.8rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .iframe-close {
      background: none;
      border: none;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .iframe-close:hover {
      opacity: 0.7;
    }

    .iframe-center-box iframe {
      flex: 1;
      border: none;
      border-radius: 0 0 16px 16px;
      background: #fff;
    }



    /* Fix markdown rendering */
    .message-ai p {
      margin: 8px 0 !important;
      display: block !important;
    }

    .message-ai ul,
    .message-ai ol {
      margin: 8px 0 !important;
      padding-left: 24px !important;
      display: block !important;
    }

    .message-ai li {
      display: list-item !important;
      margin: 4px 0 !important;
    }

    .message-ai strong {
      font-weight: bold !important;
    }

    .message-ai br {
      display: block !important;
      content: "" !important;
      margin: 4px 0 !important;
    }

    .message-ai h1,
    .message-ai h2,
    .message-ai h3 {
      display: block !important;
      margin: 12px 0 8px 0 !important;
      font-weight: bold !important;
    }

    .message-ai h1 {
      font-size: 1.5em !important;
    }

    .message-ai h2 {
      font-size: 1.3em !important;
    }

    .message-ai h3 {
      font-size: 1.1em !important;
    }

    /* --- Sidenav animation for Chats --- */
    .sidenav {
      height: 100%;
      width: 250px;
      /* Default width for desktop */
      position: fixed;
      z-index: 2000;
      top: 0;
      left: 0;
      background-color: #0d0d0d;
      overflow-x: hidden;
      transition: 0.4s;
      padding-top: 0;
      border-right: 1px solid #333;
    }

    /* Hide on mobile by default */
    @media (max-width: 768px) {
      .sidenav {
        width: 0;
        /* Collapsed on mobile */
      }

      .sidenav.open {
        width: 250px;
        /* Opens when toggled on mobile */
      }
    }

    .sidenav a {
      padding: 8px 8px 8px 32px;
      text-decoration: none;
      font-size: 18px;
      color: #ccc;
      display: block;
      transition: 0.3s;
    }

    .sidenav a:hover {
      color: #fff;
    }

    .sidenav .closebtn {
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 36px;
      color: white;
      cursor: pointer;
      display: none;
      /* Hide close button on desktop */
    }

    @media (max-width: 768px) {
      .sidenav .closebtn {
        display: block;
        /* Show close button on mobile */
      }
    }

    /* Custom scrollbar for sidenav */
    .sidenav::-webkit-scrollbar {
      width: 8px;
    }

    .sidenav::-webkit-scrollbar-track {
      background: #0d0d0d;
      border-radius: 10px;
    }

    .sidenav::-webkit-scrollbar-thumb {
      background: #ffffff;
      border-radius: 10px;
    }

    .sidenav::-webkit-scrollbar-thumb:hover {
      background: #bebebe;
    }

    /* Firefox scrollbar styling */
    .sidenav {
      scrollbar-width: thin;
      scrollbar-color: #ffffff #1a1a1a;
    }

    .bottom-div {
      position: fixed;
      bottom: 30px;
      left: 0;
      right: 0;
      padding: 0 2.5%;
      /* Use padding instead of width */
      transition: all 0.4s;
    }

    @media (min-width: 769px) {
      .bottom-div {
        left: 250px;
        /* Account for sidebar */
        padding: 0 2.5%;
      }
    }

    .top-div {
      position: fixed;
      top: 50px;
      left: 50px;
      right: 50px;
      z-index: 1000;
      background-color: #0d0d0d;
      /* Match your background */
    }

    /* From Uiverse.io by Fernando-sv */
    .loader {
      border: 4px solid #FFF;
      border-left-color: transparent;
      border-radius: 50%;
    }

    .loader {
      border: 4px solid #FFF;
      border-left-color: transparent;
      width: 30px;
      height: 30px;
    }

    .loader {
      border: 4px solid #FFF;
      border-left-color: transparent;
      width: 36px;
      height: 36px;
      animation: spin89345 1s linear infinite;
    }

    @keyframes spin89345 {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    #input-text::-webkit-scrollbar {
      width: 8px;
    }

    #input-text::-webkit-scrollbar-track {
      background: #0d0d0d;
      border-radius: 10px;
    }

    #input-text::-webkit-scrollbar-thumb {
      background: #ffffff;
      border-radius: 10px;
    }

    #input-text::-webkit-scrollbar-thumb:hover {
      background: #bebebe;
    }

    @media (min-width: 769px) {
      #sidebarToggle {
        display: none !important;
      }
    }


    .streaming-cursor {
  display: inline-block;
  width: 2px;
  height: 1em;
  background: #ffffff;
  margin-left: 2px;
  animation: blink 1s infinite;
  vertical-align: text-bottom;
}

@keyframes blink {
  0%, 49% { opacity: 1; }
  50%, 100% { opacity: 0; }
}



/* Greeting stays centered */
.greeting-message {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center !important;
   margin: 20px auto; /* ✅ Changed to auto for centering */
  max-width: calc(100% - 40px); /* ✅ Prevents overflow */
  align-self: center; /* Override the stretch */
  overflow-x: hidden; /* ✅ Prevents horizontal scroll */
  box-sizing: border-box; /* ✅ Includes padding in width calculation */
}


.greeting-message h1 {
  margin: 0 0 15px 0;
  font-size: 40px !important;
  font-family: 'Libre Baskerville', serif !important;
  color: #ffffff;
}

.greeting-message p {
  margin: 10px 0;
  line-height: 1.6;
  font-family: 'Libre Baskerville', serif !important;
}

.greeting-message ul {
  margin: 15px 0;
  padding-left: 20px;
}

.greeting-message li {
  margin: 8px 0;
  line-height: 1.5;
}

/* Dark mode support */
body.dark-mode .greeting-message {
  background: linear-gradient(135deg, rgba(102, 204, 255, 0.05), rgba(102, 153, 255, 0.05));
  border-color: rgba(102, 204, 255, 0.2);
}






.message-ai .chain-of-thought,
.message-user .chain-of-thought,
.chain-of-thought {
  font-size: 7px !important;
  font-style: italic !important;
  color: #888 !important; /* Also add a color! */
  margin-left: 10px !important;
  margin-bottom: 5px !important;
  white-space: pre-wrap !important;
  clear: both !important;
  display: block !important;
  text-align: left !important;
}


  </style>













  <div class="w-screen bg-[#0d0d0d] px-4 sm:px-6 md:px-8 lg:px-10 py-5 rounded-[3rem] space-y-12">

    <!-- Header -->
    <div class="top-div">
      <div class="chat-toolbar">
        <div class="dropdown">
          <button onclick="myFunction()" class="userbutton">
            <img src="/logos/logo/user.png" height="20px" width="20px">
          </button>
          <div id="myDropdown" class="dropdown-content">
            <a href="#" onclick="openIframe('settings.htm')">Settings</a>
            <!-- <a href="https://syvaai.com/donate.html" style="color:rgb(3, 104, 3);">Donate</a> -->
            <a href="#" onclick="openIframe('disclamer.html')">Disclamer</a>
            <a href="#" onclick="openIframe('license.html')">License</a>
            <a href="#" onclick="openIframe('report.html')">Report content</a>
          </div>
        </div>
        <button id="sidebarToggle" onclick="openNav()" class="menubut">
          <img src="/logos/logo/search-svgrepo-com.png" height="20px" width="20px">
        </button>
        <button onclick="startNewChat()" id="toggleChatsBtn" class="menubut">
          <img src="/logos/logo/newchat.png" height="20px" width="20px">
        </button>
      </div>
    </div>
    <div>
      <div id="chat"></div>



    </div>

    <div class="bottom-div">
      <div style="max-width: 100%; margin: 0 auto; position: relative; padding: 0 8px;">
        <textarea id="input-text" placeholder="Message SyväAI..." rows="1" style="
        background-color: #0d0d0d !important; 
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        font-size: 15px;
        width: 100%
      " class="w-full text-white placeholder-gray-500 rounded-xl py-3.5 px-5 focus:outline-none border border-gray-500 focus:border-gray-500 resize-none max-h-96 overflow-y-auto leading-relaxed transition-all duration-200"></textarea>
      </div>
    </div>

    <!-- Pop-out sidenav for Chats -->
    <div id="mySidenav" class="sidenav">
      <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
      <div style="padding: 12px;">
      </div>
      <div id="chatsText" style="padding: 12px; text-align: left;">
        <div class="login-containertwo">
          <small>
            <p style="color:gray;" class="text-left">Chats</p>
          </small>
        </div>
      </div>
    </div>

    <script>
      if (localStorage.getItem(DARK_MODE_KEY) === 'true') {
        enableDarkMode();
      }

      toggle.addEventListener('click', () => {
        if (body.classList.contains('dark-mode')) {
          disableDarkMode();
        } else {
          enableDarkMode();
        }
      });

      function enableDarkMode() {
        body.classList.add('dark-mode');
        if (cardOverlay) cardOverlay.classList.add('dark');
        if (cardInner) cardInner.classList.add('dark');
        localStorage.setItem(DARK_MODE_KEY, 'true');
      }

      function disableDarkMode() {
        body.classList.remove('dark-mode');
        if (cardOverlay) cardOverlay.classList.remove('dark');
        if (cardInner) cardInner.classList.remove('dark');
        localStorage.setItem(DARK_MODE_KEY, 'false');
      }
    </script>

    <script>
      function openIframe(url) {
        // create overlay
        const overlay = document.createElement("div");
        overlay.classList.add("iframe-center-overlay");

        // iframe box
        const box = document.createElement("div");
        box.classList.add("iframe-center-box");
        box.innerHTML = `
    <iframe src="${url}" loading="lazy" frameborder="0" allowfullscreen></iframe>
  `;

        overlay.appendChild(box);
        document.body.appendChild(overlay);

        // fade-in
        setTimeout(() => overlay.classList.add("visible"), 10);

        // close logic
        function closeIframe() {
          overlay.classList.remove("visible");
          setTimeout(() => overlay.remove(), 250);
          window.removeEventListener("message", onMessage);
        }

        // click outside = close
        overlay.addEventListener("click", (e) => {
          if (e.target === overlay) closeIframe();
        });

        // close button
        box.querySelector(".iframe-close").addEventListener("click", closeIframe);

        // message listener
        function onMessage(event) {
          // optionally restrict by origin: if (event.origin !== "https://syvaai.com") return;
          if (typeof event.data === "string" && event.data.toLowerCase().includes("close-iframe")) {
            closeIframe();
          }
        }

        window.addEventListener("message", onMessage);
      }

    </script>

    <script>
const textarea = document.getElementById('input-text');

textarea.addEventListener('input', () => {
  textarea.style.height = 'auto';                // reset height
  textarea.style.height = textarea.scrollHeight + 'px'; // grow or shrink
});

// ✅ Add this: Reset height when cleared
textarea.addEventListener('change', () => {
  if (textarea.value === '') {
    textarea.style.height = 'auto';
  }
});
    </script>



    <script>
      const toggle = document.getElementById('dark-toggle');
      const body = document.body;
      const DARK_MODE_KEY = 'darkMode';

      // Select card elements
      const card = document.querySelector('.card');
      const cardOverlay = document.querySelector('.card-overlay');
      const cardInner = document.querySelector('.card-inner');

      // Load saved mode
      if (localStorage.getItem(DARK_MODE_KEY) === 'true') {
        enableDarkMode();
      }

      toggle.addEventListener('click', () => {
        if (body.classList.contains('dark-mode')) {
          disableDarkMode();
        } else {
          enableDarkMode();
        }
      });

      function enableDarkMode() {
        body.classList.add('dark-mode');
        card.classList.add('dark');
        cardOverlay.classList.add('dark');
        cardInner.classList.add('dark');
        localStorage.setItem(DARK_MODE_KEY, 'true');
      }

      function disableDarkMode() {
        body.classList.remove('dark-mode');
        card.classList.remove('dark');
        cardOverlay.classList.remove('dark');
        cardInner.classList.remove('dark');
        localStorage.setItem(DARK_MODE_KEY, 'false');
      }
    </script>

    <script>
      // Show greeting message
// Show greeting message with dynamic time-based greeting
function showGreeting() {
  const chat = document.getElementById('chat');
  
  // Get current hour
  const hour = new Date().getHours();
  
  // Determine greeting based on time
  let greeting;
  let emoji;
  let bottomtext;
  
  if (hour >= 5 && hour < 12) {
    greeting = "Good morning!";
    bottomtext = "What should we talk about?";
    emoji = `<img src="/logos/logo/daytimes/sunrise-svgrepo-com.png" height="40px" width="40px">`;
  } else if (hour >= 12 && hour < 17) {
    greeting = "Good afternoon";
    bottomtext = "How are you doing today?";
    emoji = `<img src="logos/logo/daytimes/sun-svgrepo-com.png" height="80px" width="80px">`;
  } else if (hour >= 17 && hour < 21) {
    greeting = "Good evening!";
    bottomtext = "What will we dive into this hour?";
    emoji = `<img src="logos/logo/daytimes/sunrise-svgrepo-com.png" height="80px" width="80px">`;
  } else if (hour >= 1 && hour < 3) {
    greeting = "Go to bed";
    bottomtext = "Seriously";
    emoji = `<img src="logos/logo/daytimes/moon-sleep-svgrepo-com.png" height="80px" width="80px">`;
  } else if (hour >= 3 && hour < 5) {
    greeting = "It's a bit early, don't you think?";
    bottomtext = "What should we talk about?";
    emoji = `<img src="logos/logo/daytimes/moon-sleep-svgrepo-com.png" height="80px" width="80px">`;
  } else {
    greeting = "Hello, night owl.";
    bottomtext = "Late night convo?";
    emoji = `<img src="logos/logo/daytimes/moon-svgrepo-com.png" height="80px" width="80px">`;
  }
  
  const greetingDiv = document.createElement('div');
  greetingDiv.classList.add('message', 'message-ai', 'greeting-message');
  greetingDiv.id = 'greeting-message';
  
  greetingDiv.innerHTML = `
    <h1>${emoji}${greeting}</h1>
    <p>${bottomtext}</p>
  `;
  
  chat.appendChild(greetingDiv);
}

// ✅ Remove greeting when first message is sent
function removeGreeting() {
  const greeting = document.getElementById('greeting-message');
  if (greeting) {
    greeting.style.opacity = '0';
    greeting.style.transform = 'translateY(-10px)';
    setTimeout(() => greeting.remove(), 300);
  }
}



    </script>




    <script>
      function toggleArtifact(show, content = '') {
        const pane = document.getElementById('artifactPane');
        const pre = document.getElementById('artifactContent');
        if (show) {
          pre.textContent = content.trim();
          pane.classList.remove('hidden');
        } else {
          pane.classList.add('hidden');
        }
      }

    </script>

    <script>
function appendMessage(sender, message, chainOfThought = '') {
  const chat = document.getElementById('chat');

  // MAIN MESSAGE
  const messageDiv = document.createElement('div');
  messageDiv.classList.add('message', sender === 'User' ? 'message-user' : 'message-ai');

  if (sender === 'AI' || sender === 'Assistant') {
    const cleanConfig = {
      ALLOWED_TAGS: ['div', 'span', 'p', 'h1', 'h2', 'h3', 'h4', 'ul', 'ol', 'li', 'strong', 'em', 'code', 'pre', 'table', 'tr', 'td', 'th', 'thead', 'tbody', 'br', 'hr', 'a', 'img', 'small', 'details', 'summary'],
      ALLOWED_ATTR: ['style', 'class', 'onmouseover', 'onmouseout', 'onclick', 'href', 'src', 'alt', 'title'],
      ALLOW_DATA_ATTR: false,
      KEEP_CONTENT: true
    };

    let rendered = marked.parse(message, { breaks: true, gfm: true });

    // Unescape HTML entities inside <pre><code>
    rendered = rendered.replace(/<pre><code>([\s\S]*?)<\/code><\/pre>/g, (match, code) => {
      const textarea = document.createElement('textarea');
      textarea.innerHTML = code;
      return textarea.value;
    });

    messageDiv.innerHTML = DOMPurify.sanitize(rendered, cleanConfig);
  } else {
    messageDiv.textContent = message;
  }

  chat.appendChild(messageDiv);

  // CHAIN OF THOUGHT (preserve line breaks)
  if (chainOfThought && (sender === 'AI' || sender === 'Assistant')) {
    const cotDiv = document.createElement('div');
    cotDiv.classList.add('chain-of-thought');
    cotDiv.style.whiteSpace = 'pre-wrap';
    cotDiv.textContent = chainOfThought;


    // Preserve line breaks
    cotDiv.style.whiteSpace = 'pre-wrap';
    cotDiv.textContent = chainOfThought;

    chat.appendChild(cotDiv);
  }

  chat.scrollTop = chat.scrollHeight;
}

    </script>

    <!-- Dropdown menu visibility management -->
    <script>
      // ADD THIS AT THE TOP - Track session ID
      let currentSessionId = null;

      initializeChat();

      function initializeChat() {
        const input = document.getElementById('input');
        input.addEventListener("keyup", (e) => {
          if (e.key === "Enter" && input.value.trim()) {
            sendMessage(input.value.trim());
            input.value = "";
          }
        });
      }

      

async function sendMessage(message) {
  removeGreeting();

  appendMessage("User", message);

  const chat = document.getElementById('chat');

  // Create AI message with loader
  const loaderDiv = document.createElement('div');
  loaderDiv.classList.add('message', 'message-ai');
  loaderDiv.innerHTML = `<div class="loader"></div>`;
  chat.appendChild(loaderDiv);
  chat.scrollTop = chat.scrollHeight;

  const startTime = Date.now();

  // Get current date and time
  const now = new Date();
  const currentDateTime = now.toLocaleString('en-US', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    timeZoneName: 'short'
  });

  try {
    const response = await fetch('https://api.syvaai.xyz/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        question: message,
        top_k: 2,
        session_id: currentSessionId,
        current_datetime: currentDateTime
      })
    });

    const data = await response.json();

    if (data.session_id) {
      currentSessionId = data.session_id;
    }

    const chainOfThought = data.chain_of_thought || '';

    const aiMessage = data.answer ?? data.response ?? `<div class="error-alert">
  <p class="alert-content">
    <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24"
      stroke-linecap="round" stroke-linejoin="round" height="28" width="28"
      class="icon-lg" xmlns="http://www.w3.org/2000/svg">
      <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
      <path d="M12 9v4"></path>
      <path d="M12 17h.01"></path>
    </svg>
    <small><small>API Error<hr>
    A error occured. (Error code 5002)<hr>
    <a href="https://syvaai.com/docs/error5002/"><u>Click here</u></a>
    for a explanation for this error.</small></small>
  </p></div>`;

    // Ensure loader shows at least 1 second
    const elapsed = Date.now() - startTime;
    const delay = Math.max(0, 1000 - elapsed);

    setTimeout(() => {
      // Remove loader
      loaderDiv.remove();

      // Create new message div for streaming effect
      const aiMessageDiv = document.createElement('div');
      aiMessageDiv.classList.add('message', 'message-ai');
      chat.appendChild(aiMessageDiv);

      // ✅ STREAMING EFFECT - word by word
      streamText(aiMessageDiv, aiMessage, () => {

          if (chainOfThought) {
    const cotDiv = document.createElement('div');
    cotDiv.classList.add('chain-of-thought');
    cotDiv.textContent = chainOfThought;
    chat.appendChild(cotDiv);
          }
        // Save to Firebase after streaming completes
        saveMessageToFirebase(message, aiMessage, chainOfThought);
      });

    }, delay);

    if (!activeChatId || !chatSessions[activeChatId]) {
      activeChatId = 'chat_' + Date.now();
      chatSessions[activeChatId] = {
        id: activeChatId,
        title: message.substring(0, 30) || "New Chat",
        messages: [],
        sessionId: currentSessionId,
        created: Date.now(),
        lastUpdated: Date.now()
      };
    }

  } catch (error) {
    console.error("API Error:", error);

    const elapsed = Date.now() - startTime;
    const delay = Math.max(0, 1000 - elapsed);

    setTimeout(() => {
      loaderDiv.innerHTML = `<div class="error-alert">
    <p class="alert-content">
      <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24"
        stroke-linecap="round" stroke-linejoin="round" height="28" width="28"
        class="icon-lg" xmlns="http://www.w3.org/2000/svg">
        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
        <path d="M12 9v4"></path>
        <path d="M12 17h.01"></path>
      </svg>
      <small><small>API Error<hr>
      A error occured. (Error code 5001)<hr>
      <a href="https://syvaai.com/docs/error5001/"><u>Click here</u></a>
      for a explanation for this error.</small></small>
    </p></div>`;
      chat.scrollTop = chat.scrollHeight;
    }, delay);
  }
}

// ✅ SMART STREAMING - Adapts speed based on response length
function streamText(element, text, onComplete) {
  // Parse markdown first
  let rendered = marked.parse(text, {
    breaks: true,
    gfm: true
  });

  // Clean with DOMPurify
  const cleanConfig = {
    ALLOWED_TAGS: ['div', 'span', 'p', 'h1', 'h2', 'h3', 'h4', 'ul', 'ol', 'li', 'strong', 'em', 'code', 'pre', 'table', 'tr', 'td', 'th', 'thead', 'tbody', 'br', 'hr', 'a', 'img', 'small', 'details', 'summary'],
    ALLOWED_ATTR: ['style', 'class', 'href', 'src', 'alt', 'title'],
    ALLOW_DATA_ATTR: false,
    KEEP_CONTENT: true
  };
  const cleanHTML = DOMPurify.sanitize(rendered, cleanConfig);

  // Split into chunks (by words for smoother effect)
  const words = cleanHTML.split(/(<[^>]+>|\s+)/);
  const totalWords = words.length;
  
  // ✅ ADAPTIVE SPEED CALCULATION
  let speed;
  if (totalWords < 50) {
    speed = 30; // Short response: slow and readable (50ms per word)
  } else if (totalWords < 200) {
    speed = 15; // Medium response: moderate speed (30ms)
  } else if (totalWords < 500) {
    speed = 10; // Long response: faster (15ms)
  } else {
    speed = 1; // Very long response: very fast (8ms)
  }

  let currentIndex = 0;

  // Add cursor
  element.innerHTML = '<span class="streaming-cursor"></span>';

  const interval = setInterval(() => {
    if (currentIndex < words.length) {
      // Remove cursor
      element.innerHTML = element.innerHTML.replace('<span class="streaming-cursor"></span>', '');
      
      // Add next word
      element.innerHTML += words[currentIndex];
      
      // Re-add cursor
      element.innerHTML += '<span class="streaming-cursor"></span>';
      
      currentIndex++;

      // Auto-scroll
      const chat = document.getElementById('chat');
      chat.scrollTop = chat.scrollHeight;
    } else {
      clearInterval(interval);
      
      // Remove cursor when done
      element.innerHTML = element.innerHTML.replace('<span class="streaming-cursor"></span>', '');
      
      // Call completion callback
      if (onComplete) onComplete();
    }
  }, speed);
}


      function changeContent2() {
        alert("Coming soon!");
      }

      function openNav() {
        if (window.innerWidth <= 768) {
          document.getElementById("mySidenav").classList.add("open");
        }
        // Do nothing on desktop - sidebar is already open
      }

      function closeNav() {
        if (window.innerWidth <= 768) {
          document.getElementById("mySidenav").classList.remove("open");
        }
        // Do nothing on desktop - sidebar stays open
      }

      async function startNewChat() {
        // Make sure no ghost chat is created
        const chatId = 'chat_' + Date.now();
        chatSessions[chatId] = {
          id: chatId,
          title: 'New Chat',
          messages: [],
          sessionId: null,
          created: Date.now(),
          lastUpdated: Date.now()
        };

        activeChatId = chatId;
        currentSessionId = null;
        document.getElementById('chat').innerHTML = '';

        showGreeting()

        // 🟡 Only save AFTER first message is sent
        renderChatList();
        console.log("Started new conversation (not yet saved):", chatId);
      }
      // Filter chats based on search input
      const chatSearchInput = document.getElementById('chatSearch');

      if (chatSearchInput) {
        chatSearchInput.addEventListener('input', () => {
          const query = chatSearchInput.value.toLowerCase().trim();

          // Get all chat divs that exist right now
          const chatDivs = document.querySelectorAll('[data-chat-id]');

          chatDivs.forEach(chatDiv => {
            const chatId = chatDiv.getAttribute('data-chat-id');
            const chat = chatSessions[chatId];

            if (!chat) return;

            const title = chat.title.toLowerCase();

            // Show if query is empty OR title matches
            if (query === '' || title.includes(query)) {
              chatDiv.style.display = 'flex';
            } else {
              chatDiv.style.display = 'none';
            }
          });
        });
      }
showGreeting();
    </script>
    <!-- Popup reminder visibility persistence -->
    <script>
      // Grab the text input
      const inputText = document.getElementById('input-text');

      // Make it respond to Enter key
      inputText.addEventListener('keyup', (e) => {
        if (e.key === 'Enter' && inputText.value.trim()) {
          sendMessage(inputText.value.trim());
          inputText.value = ""; // clear input after sending
          
          // ✅ Reset textarea height after sending
          inputText.style.height = 'auto';
        }
      });

      

      // Reuse your existing sendMessage() and appendMessage() functions
    </script>
    <script>
      function openNav() {
        document.getElementById("mySidenav").style.width = "300px";
      }

      function closeNav() {
        document.getElementById("mySidenav").style.width = "0";
      }
    </script>


    <script>
      function myFunction() {
        var dropdown = document.getElementById("myDropdown");
        if (dropdown.style.display === "block") {
          dropdown.style.display = "none";
        } else {
          dropdown.style.display = "block";
        }
      }

      // Close the dropdown if the user clicks outside of it
      window.onclick = function (event) {
        if (!event.target.closest('.dropdown')) {
          var dropdown = document.getElementById("myDropdown");
          dropdown.style.display = "none";
        }
      }
    </script>

    <script>
      window.onload = function () {
        // Check if the user already closed the popup
        const hasClosedPopup = localStorage.getItem('popupClosed');
        const popup = document.getElementById('popup');

        // Only show the popup if it hasn't been closed before
        if (!hasClosedPopup) {
          setTimeout(function () {
            popup.style.display = 'block'; // Make it block so it occupies space
            setTimeout(function () {
              popup.style.opacity = '1'; // Fade in
            }, 10); // Slight delay to trigger CSS transition
          }, 1000);
        }

        // Attach close event to the button
        const closeBtn = document.getElementById('close-btn');
        closeBtn.onclick = function () {
          popup.style.opacity = '0'; // Fade out
          setTimeout(function () {
            popup.style.display = 'none';
            localStorage.setItem('popupClosed', 'true'); // Remember user closed popup
          }, 500);
        };
      };

      async function deleteChat(chatId, event) {
        event.stopPropagation();

        if (!confirm('Delete this chat?')) return;

        const user = firebase.auth().currentUser;

        // Delete from Firebase
        if (user && db) {
          try {
            await db.collection('users').doc(user.uid).collection('chats').doc(chatId).delete();
            console.log('Deleted from Firebase:', chatId);
          } catch (e) {
            console.error('Error deleting:', e);
          }
        }

        // Delete locally
        delete chatSessions[chatId];

        // If we deleted the active chat, start a new one
        if (activeChatId === chatId) {
          await startNewChat();
        } else {
          renderChatList();
        }
      }

      async function renameChat(chatId, event) {
        event.stopPropagation();
        const newName = prompt("Rename chat:", chatSessions[chatId]?.title || "New Chat");
        if (!newName) return;

        chatSessions[chatId].title = newName.trim();
        const user = firebase.auth().currentUser;

        if (user && db) {
          await db.collection('users').doc(user.uid).collection('chats').doc(chatId).update({
            title: newName.trim(),
            lastUpdated: Date.now()
          });
        }

        renderChatList();
      }

    </script>
    <!-- Persistent chat history synchronization -->
    <script>
      // Firebase chat list only
      let chatSessions = {};
      let activeChatId = null;
      let db;

      setTimeout(() => {
        if (firebase && firebase.firestore) {
          db = firebase.firestore();
          firebase.auth().onAuthStateChanged((user) => {
            if (user) {
              loadChatsFromFirebase(user.uid);
            }
          });
        }
      }, 1000);

      async function loadChatsFromFirebase(userId) {
        if (!db) return;
        try {
          const snapshot = await db.collection('users').doc(userId).collection('chats').orderBy('lastUpdated', 'desc').get();
          chatSessions = {};
          snapshot.forEach(doc => chatSessions[doc.id] = doc.data());
          renderChatList();
        } catch (e) {
          console.error('Error loading chats:', e);
        }
      }

      function renderChatList() {
        const container = document.getElementById('chatsText');
        if (!container) return;

        const chatIds = Object.keys(chatSessions);
        if (chatIds.length === 0) {
          container.innerHTML = '<div class="login-containertwo"><small><p style="color:gray;">No chats yet</p></small></div>';
          return;
        }

        let html = '<div class="login-containertwo"><small><p style="color:gray;">Chats</p></small></div>';

        chatIds.forEach(chatId => {
          const chat = chatSessions[chatId];
          const title = chat.title || 'New Chat';
          const isActive = chatId === activeChatId;



          html += `
  <div data-chat-id="${chatId}" style="
    padding: 10px;
    margin: 8px;
    background: ${isActive ? 'rgba(100,100,255,0.2)' : 'rgba(255,255,255,0.1)'};
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  ">
    <div onclick="loadChatFromList('${chatId}')" style="flex: 1; cursor: pointer;">
      <small>${title}</small>
    </div>
    <div style="display: flex; gap: 6px;">
      <button onclick="renameChat('${chatId}', event)" 
        style="background: none; border: none; color: #66ccff; cursor: pointer; padding: 4px 8px; font-size: 14px;">
        <img src="/logos/logo/pencil-svgrepo-com.png" height="20px" width="20px">
      </button>
      <button onclick="deleteChat('${chatId}', event)" 
        style="background: none; border: none; color: #ff4444; cursor: pointer; padding: 4px 8px; font-size: 18px;">
        <img src="/logos/logo/trash-alt-svgrepo-com.png" height="20px" width="20px">
      </button>
    </div>
  </div>
`;

        });

        container.innerHTML = html;
      }

function loadChatFromList(chatId) {
  const chat = chatSessions[chatId];
  if (!chat) return;

  // Clear current chat messages
  document.getElementById('chat').innerHTML = '';

  // ✅ Show greeting only if chat is empty
  if (!chat.messages || chat.messages.length === 0) {
    showGreeting();
  } else {
    // ✅ Load messages with chain-of-thought
    chat.messages.forEach(msg => {
      appendMessage(msg.sender, msg.content, msg.chainOfThought || '');
    });
  }

  // Set active session
  activeChatId = chatId;
  currentSessionId = chat.sessionId;

  // Re-render list to highlight the active chat
  renderChatList();

  // ✅ Only close sidenav on mobile
  if (window.innerWidth <= 768) {
    closeNav();
  }
}



      async function saveMessageToFirebase(userMsg, aiMsg, chainOfThought = '') {  // ✅ ADD PARAMETER
  const user = firebase.auth().currentUser;
  if (!user || !db) return;

  // Create new chat if none active
  if (!activeChatId) {
    activeChatId = 'chat_' + Date.now();
    chatSessions[activeChatId] = {
      id: activeChatId,
      title: userMsg.substring(0, 30),
      messages: [],
      sessionId: currentSessionId,
      created: Date.now(),
      lastUpdated: Date.now()
    };
  }

  // Add messages
  chatSessions[activeChatId].messages.push(
    { sender: 'User', content: userMsg, timestamp: Date.now() },
    { 
      sender: 'AI', 
      content: aiMsg, 
      chainOfThought: chainOfThought,  // ✅ ADD THIS FIELD
      timestamp: Date.now() 
    }
  );
  chatSessions[activeChatId].lastUpdated = Date.now();
  chatSessions[activeChatId].sessionId = currentSessionId;

  // Save to Firebase
  try {
    await db.collection('users').doc(user.uid).collection('chats').doc(activeChatId).set(chatSessions[activeChatId]);
    renderChatList(); // Update sidebar
  } catch (e) {
    console.error('Error saving:', e);
  }
}
    </script>
    <script>
      // ✅ START NEW CHAT — prevents ghost "New Chat" spam
      async function startNewChat() {
        const chatId = 'chat_' + Date.now();
        chatSessions[chatId] = {
          id: chatId,
          title: 'New Chat',
          messages: [],
          sessionId: null,
          created: Date.now(),
          lastUpdated: Date.now()
        };

        

        activeChatId = chatId;
        currentSessionId = null;
        document.getElementById('chat').innerHTML = '';

        // 🟡 Don't save yet — only after first message
        renderChatList();
        console.log("Started new chat (not saved until message):", chatId);
      }

      // ✅ LOAD CHATS — cleans up empties automatically
      async function loadChatsFromFirebase(userId) {
        if (!db) return;
        try {
          const snapshot = await db.collection('users')
            .doc(userId)
            .collection('chats')
            .orderBy('lastUpdated', 'desc')
            .get();

          chatSessions = {};
          const batch = db.batch();

          snapshot.forEach(doc => {
            const data = doc.data();
            if (data.messages && data.messages.length > 0) {
              chatSessions[doc.id] = data;
            } else {
              // Delete ghost/empty chats
              const ref = db.collection('users').doc(userId).collection('chats').doc(doc.id);
              batch.delete(ref);
            }
          });

          await batch.commit();
          renderChatList();
          console.log("✅ Chats loaded, ghosts removed:", Object.keys(chatSessions).length);
        } catch (e) {
          console.error('⚠️ Error loading chats:', e);
        }
      }

    </script>
    <script>
      // ✅ Add this at the end of your script or in window.onload
window.addEventListener('DOMContentLoaded', () => {
  // Show greeting if chat is empty
  const chat = document.getElementById('chat');
  if (!chat.children.length) {
    showGreeting();
  }
});
    </script>
</body>

</html>